<?xml version="1.0" encoding="utf-8"?>
<Gdb xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns="http://jasonzhu/db_xml_conf.xsd">
  <Var name="#WICols" value="WorkItemId,Title,ViewPath,RelatedIdx,FinishActionPath,AssignedUser,State,FlowInsId,FlowNodeInsId,Priority,LimitDate,DataCont" />
  <Var name="#WILogCols" value="LogId,WorkItemId,UserName,LogDate,LogType,LogDesc" />
  <Var name="#WIState.Normal" value="0"/>
  <Var name="#WIState.Finished" value="1"/>
  <Var name="#WIState.Canceled" value="2"/>
  <Var name="#WIState.Abort" value="3"/>
  
  <Var name="#WILogType.Create" value="0"/>
  <Var name="#WILogType.Acquire" value="1"/>
  <Var name="#WILogType.Finish" value="2"/>
  <Var name="#WILogType.Assign" value="3"/>
  <Var name="#WILogType.Cancel" value="4"/>
  <Var name="#WILogType.Direct" value="5"/>
  <Var name="#WILogType.Abort" value="6"/>
  
  <XORM name="#BizWorkItem" class="com.dw.biz.workitem.BizWorkItem"/>
  <XORM name="#BizWorkItemLog" class="com.dw.biz.workitem.BizWorkItemLog"/>
  
  <!-- Install_For_DB table_names="">
    <Sql>
      create table biz_workitem(WorkItemId bigint GENERATED BY DEFAULT AS IDENTITY(START WITH 1) PRIMARY KEY,
      Title varchar(200) not null,ViewPath varchar(50),RelatedIdx varchar(50),FinishActionPath varchar(50),AssignedUser varchar(30),State integer,
      FlowInsId bigint,FlowNodeInsId varchar(40),CostSecond bigint,Priority integer,LimitDate TIMESTAMP,DataCont BLOB)
    </Sql>
    <Sql>create index idx_biz_workitem_assigneduser on biz_workitem (AssignedUser)</Sql>
    <Sql>create index idx_biz_workitem_viewpath on biz_workitem (ViewPath)</Sql>
    <Sql>create index idx_biz_workitem_relatedidx on biz_workitem (RelatedIdx)</Sql>
    <Sql>alter table biz_workitem alter column AssignedUser default ''</Sql>
    <Sql>alter table biz_workitem alter column State default 0</Sql>
    <Sql>alter table biz_workitem alter column FlowInsId default -1</Sql>
    <Sql>alter table biz_workitem alter column FlowNodeInsId default ''</Sql>
    <Sql>alter table biz_workitem alter column CostSecond default -1</Sql>
    <Sql>alter table biz_workitem alter column Priority default 0</Sql>
    
    <Sql>
      create table biz_workitem_log(LogId bigint GENERATED BY DEFAULT AS IDENTITY(START WITH 1) PRIMARY KEY,
      WorkItemId bigint not null,UserName varchar(30),
      LogDate TIMESTAMP,LogType integer,LogDesc varchar(400))
    </Sql>
    <Sql>alter table biz_workitem_log alter column UserName default ''</Sql>
    <Sql>create index idx_biz_workitem_log_workitemid on biz_workitem_log (WorkItemId)</Sql>
    <Sql>create index idx_biz_workitem_log_username on biz_workitem_log (UserName)</Sql>
    <Sql>alter table biz_workitem_log alter column LogType default 0</Sql>
    <Sql>
      ALTER TABLE biz_workitem_log ADD CONSTRAINT FK_biz_workitem_log_workitemid FOREIGN KEY
      (WorkItemId) REFERENCES biz_workitem (WorkItemId) ON DELETE CASCADE
    </Sql>
  </Install_For_DB>
  <Install_For_DB db_type="mysql">
  	<Sql>
      create table biz_workitem(WorkItemId bigint AUTO_INCREMENT PRIMARY KEY,
      Title varchar(200) not null,ViewPath varchar(50),RelatedIdx varchar(50),FinishActionPath varchar(50),AssignedUser varchar(30),State integer,
      FlowInsId bigint,FlowNodeInsId varchar(40),CostSecond bigint,Priority integer,LimitDate datetime,DataCont BLOB) ENGINE=InnoDB
    </Sql>
    <Sql>create index idx_biz_workitem_assigneduser on biz_workitem (AssignedUser)</Sql>
    <Sql>create index idx_biz_workitem_viewpath on biz_workitem (ViewPath)</Sql>
    <Sql>create index idx_biz_workitem_relatedidx on biz_workitem (RelatedIdx)</Sql>
    <Sql>alter table biz_workitem alter column AssignedUser set default ''</Sql>
    <Sql>alter table biz_workitem alter column State set default 0</Sql>
    <Sql>alter table biz_workitem alter column FlowInsId set default -1</Sql>
    <Sql>alter table biz_workitem alter column FlowNodeInsId set default ''</Sql>
    <Sql>alter table biz_workitem alter column CostSecond set default -1</Sql>
    <Sql>alter table biz_workitem alter column Priority set default 0</Sql>
    
    <Sql>
      create table biz_workitem_log(LogId bigint AUTO_INCREMENT PRIMARY KEY,
      WorkItemId bigint not null,UserName varchar(30),
      LogDate datetime,LogType integer,LogDesc varchar(400)) ENGINE=InnoDB
    </Sql>
    <Sql>alter table biz_workitem_log alter column UserName set default ''</Sql>
    <Sql>create index idx_biz_workitem_log_workitemid on biz_workitem_log (WorkItemId)</Sql>
    <Sql>create index idx_biz_workitem_log_username on biz_workitem_log (UserName)</Sql>
    <Sql>alter table biz_workitem_log alter column LogType set default 0</Sql>
    <Sql>
      ALTER TABLE biz_workitem_log ADD CONSTRAINT FK_biz_workitem_log_workitemid FOREIGN KEY
      (WorkItemId) REFERENCES biz_workitem (WorkItemId) ON DELETE CASCADE
    </Sql>
  </Install_For_DB>
  <Install_For_DB db_type="sqlserver">
  	<Sql>
      create table biz_workitem(WorkItemId bigint IDENTITY (1, 1) PRIMARY KEY,
      Title varchar(200) not null,ViewPath varchar(50),RelatedIdx varchar(50),FinishActionPath varchar(50),
      AssignedUser varchar(30) default '',
      State integer default 0,
      FlowInsId bigint default -1,FlowNodeInsId varchar(40) default '',CostSecond bigint default -1,
      Priority integer default 0,LimitDate datetime,
      DataCont image)
    </Sql>
    <Sql>create index idx_biz_workitem_assigneduser on biz_workitem (AssignedUser)</Sql>
    <Sql>create index idx_biz_workitem_viewpath on biz_workitem (ViewPath)</Sql>
    <Sql>create index idx_biz_workitem_relatedidx on biz_workitem (RelatedIdx)</Sql>
    
    <Sql>
      create table biz_workitem_log(LogId bigint IDENTITY (1, 1) PRIMARY KEY,
      WorkItemId bigint not null,UserName varchar(30) default '',
      LogDate datetime,LogType integer default 0,LogDesc varchar(400))
    </Sql>
    <Sql>create index idx_biz_workitem_log_workitemid on biz_workitem_log (WorkItemId)</Sql>
    <Sql>create index idx_biz_workitem_log_username on biz_workitem_log (UserName)</Sql>
    <Sql>
      ALTER TABLE biz_workitem_log ADD CONSTRAINT FK_biz_workitem_log_workitemid FOREIGN KEY
      (WorkItemId) REFERENCES biz_workitem (WorkItemId) ON DELETE CASCADE
    </Sql>
  </Install_For_DB -->
  
  <Module name="WorkItem" desc="">
    <Func name="ChangeState" desc="" exe_type="nonquery">
      <InParam name="@State" />
      <InParam name="@UserName" />
      <Content_For_DB >
        <Sql exe_type="update">
          update security_users set State=[@State] where UserName=[@UserName]
        </Sql>
      </Content_For_DB>
    </Func>
    <Func name="GetWorkItemById" desc="" pure_select="true">
      <InParam name="@WorkItemId" type="Int64" />
      <Content_For_DB>
        <Sql exe_type="select">
          select #BizWorkItem.pk_nor_cols from biz_workitem where WorkItemId=[@WorkItemId]
        </Sql>
      </Content_For_DB>
    </Func>
    <Func name="GetWorkItemsByAssignedUser" desc="" pure_select="true">
      <InParam name="@AssignedUser" />
      <InParam name="@ViewPath" nullable="true"/>
      <InParam name="@State" type="Int32" nullable="true"/>
      <InParam name="@RelatedIdx" nullable="true"/>
      <Content_For_DB >
        <Sql exe_type="select">
        select #BizWorkItem.m_dot_pk_nor_cols,FlowPath
        from biz_workitem m right outer join biz_flow_ins bfi on bfi.FlowInsId=m.FlowInsId
        where AssignedUser=[@AssignedUser]{ and ViewPath=[@ViewPath]}{ and RelatedIdx=[@RelatedIdx]}{ and State=[@State]}
        order by CreationDate desc
        </Sql>
      </Content_For_DB>
    </Func>
    <Func name="GetWorkItemsByCreationUser" desc="" pure_select="true">
      <InParam name="@CreationUser" />
      <InParam name="@State" type="Int32" nullable="true"/>
      <InParam name="@RelatedIdx" nullable="true"/>
      <Content_For_DB >
        <Sql exe_type="select">
        select #BizWorkItem.pk_nor_cols
        from biz_workitem
        where CreationUser=[@CreationUser]{ and State=[@State]}{ and RelatedIdx=[@RelatedIdx]}
        order by CreationDate desc
        </Sql>
      </Content_For_DB>
    </Func>
    <Func name="GetWorkItemsByCanReplace" desc="" pure_select="true">
      <InParam name="@UserName" />
      <InParam name="$UserNameStr" />
      <InParam name="@State" type="Int32" nullable="true"/>
      <InParam name="@CurDT" type="DateTime"/>
      <Content_For_DB >
        <Sql exe_type="select">
        select #BizWorkItem.pk_nor_cols
        from biz_workitem
        where ((AssignedUser is null or AssignedUser='') or (AssignedUser!=[@UserName] and LimitDate is not null and LimitDate&lt;[@CurDT]))
        	and ReplaceUsers like '%|[$UserNameStr]|%'
			and State=[@State]
        </Sql>
      </Content_For_DB>
    </Func>
    <Func name="GetUnsignedWorkItemsByFlowIns" desc="" pure_select="true">
      <InParam name="@CreationUser" />
      <InParam name="@FlowInsId" type="Int64"/>
      <InParam name="@AssignStyle" type="Int32"/>
      <Content_For_DB >
        <Sql exe_type="select">
        select #BizWorkItem.pk_nor_cols from biz_workitem
        where FlowInsId=[@FlowInsId] and CreationUser=[@CreationUser] and State=0 and AssignedUser='' and AssignStyle=[@AssignStyle]
        </Sql>
      </Content_For_DB>
    </Func>
    <Func name="GetUnsignedFirstAcceptWorkItemsByFlowIns" desc="" pure_select="true">
      <InParam name="@FlowNodeIds"/>
      <InParam name="@AssignStyle" type="Int32"/>
      <Content_For_DB >
        <Sql exe_type="select">
        select #BizWorkItem.pk_nor_cols from biz_workitem
        where FlowNodeInsId in  and State=0 and AssignedUser='' and AssignStyle=[@AssignStyle]
        order by CreationDate desc
        </Sql>
      </Content_For_DB>
    </Func>
    <Func name="GetWorkItemsByViewPath" desc="根据view路径获得相关的工作项,它和relatedidx配合可以为其他应用提供获得和自己相关的工作项">
      <InParam name="@ViewPath"/>
      <InParam name="@AssignedUser" nullable="true"/>
      <InParam name="@State" type="Int32" nullable="true"/>
      <InParam name="@RelatedIdx" nullable="true"/>
      <Content_For_DB >
        <Sql exe_type="select">
        select #BizWorkItem.pk_nor_cols
        from biz_workitem
        where ViewPath=[@ViewPath]{ and AssignedUser=[@AssignedUser]}{ and State=[@State]}{ and RelatedIdx=[@RelatedIdx]}
        </Sql>
      </Content_For_DB>
    </Func>
    <Func name="GetWorkItemsByFlowInsId" desc="根据流程实例id获得相关的工作项,它和relatedidx配合可以为其他应用提供获得和自己相关的工作项">
      <InParam name="@FlowInsId" type="Int64"/>
      <Content_For_DB >
        <Sql exe_type="select">
        select #BizWorkItem.pk_nor_cols
        from biz_workitem where FlowInsId=[@FlowInsId] order by CreationDate
        </Sql>
      </Content_For_DB>
    </Func>
    <Func name="CreateWorkItemWithLog" desc="">
      <InParam name="@CreationUser" default_val=""/>
      <InParam name="@Title" />
      <InParam name="@CreationDate" type="DateTime" />
      <InParam name="@ViewPath"/>
      <InParam name="@RelatedIdx"/>
      <InParam name="@FinishActionPath" nullable="true"/>
      <InParam name="@AssignedUser" default_val="" />
      <InParam name="@AssignStyle" type="Int32" default_val="0" />
      <InParam name="@FlowInsId" type="Int64" default_val="-1" />
      <InParam name="@FlowNodeInsId" default_val="" />
      <InParam name="@Priority" type="Int32" default_val="0" />
      <InParam name="@LimitDate" type="DateTime" nullable="true"/>
      <InParam name="@ReplaceUsers" nullable="true"/>
      <InParam name="@DataCont" type="ByteArray" nullable="true"/>
      <InParam name="@LogDate" type="DateTime" default_val="CURRENT_TIMESTAMP()"/>
      <InParam name="@NewWorkItemId" type="Int64" nullable="true"/>
      
      <Content_For_DB >
        <Sql exe_type="insert">
          insert into biz_workitem
          (Title,CreationDate,ViewPath,RelatedIdx,FinishActionPath,CreationUser,AssignedUser,AssignStyle,State,FlowInsId,FlowNodeInsId,Priority,LimitDate,ReplaceUsers,DataCont)
          values
          ([@Title],[@CreationDate],[@ViewPath],[@RelatedIdx],[@FinishActionPath],[@CreationUser],[@AssignedUser],[@AssignStyle],#WIState.Normal,[@FlowInsId],[@FlowNodeInsId],[@Priority],[@LimitDate],[@ReplaceUsers],[@DataCont])
        </Sql>
        <Sql type="auto_fit" set_param="@NewWorkItemId=(0,0)" desc="获得新的workitemid,并给下一个语句使用">
          select_identity
        </Sql>
        <Sql desc="加入到日志中" exe_type="insert">
          insert into biz_workitem_log (WorkItemId,UserName,LogDate,LogType,LogDesc)
          values
          ([@NewWorkItemId],[@CreationUser],[@LogDate],#WILogType.Create,'')
        </Sql>
      </Content_For_DB>
    </Func>
    
    <Func name="FinishWorkItemWithLog" desc="">
      <InParam name="@WorkItemId" type="Int64"/>
      <InParam name="@OperUser" nullable="true"/>
      <InParam name="@CostSecond" type="Int64" default_val="-1"/>
      <InParam name="@DataCont" type="ByteArray" nullable="true"/>
      <InParam name="@LogDate" type="DateTime" default_val="CURRENT_TIMESTAMP()"/>
      <Content_For_DB>
        <Sql exe_type="update" set_param="@UpRows=(0,0)">
          update biz_workitem set State=#WIState.Finished,EndDate=[@LogDate],CostSecond=[@CostSecond],DataCont=[@DataCont] where WorkItemId=[@WorkItemId] and State=#WIState.Normal
        </Sql>
        <Sql exe_type="insert" if="@UpRows==1">
          insert into biz_workitem_log (WorkItemId,UserName,LogDate,LogType,LogDesc)
          values
          ([@WorkItemId],[@OperUser],[@LogDate],#WILogType.Finish,'')
        </Sql>
      </Content_For_DB>
    </Func>
    
    <Func name="CancelWorkItemWithLog" desc="有权限的用户取消工作项">
      <InParam name="@WorkItemId" type="Int64"/>
      <InParam name="@OperUser"/>
      <InParam name="@CancelDesc" default_val=""/>
      <InParam name="@LogDate" type="DateTime" default_val="CURRENT_TIMESTAMP()"/>
      <Content_For_DB>
        <Sql exe_type="update">
          update biz_workitem set State=#WIState.Canceled,EndDate=[@LogDate] where WorkItemId=[@WorkItemId]
        </Sql>
        <Sql exe_type="insert">
          insert into biz_workitem_log (WorkItemId,UserName,LogDate,LogType,LogDesc)
          values
          ([@WorkItemId],[@OperUser],[@LogDate],#WILogType.Cancel,[@CancelDesc])
        </Sql>
      </Content_For_DB>
    </Func>
    
    <Func name="AbortWorkItemWithByFlowIns" desc="根据流程实例终止工作项">
      <InParam name="@FlowInsId" type="Int64"/>
      <InParam name="@LogDate" type="Date"/>
      <Content_For_DB>
        <Sql exe_type="update">
          update biz_workitem set State=#WIState.Abort,EndDate=[@LogDate] where FlowInsId=[@FlowInsId]
        </Sql>
      </Content_For_DB>
    </Func>
    
    <Func name="AssignWorkItemWithLog" desc="有权限的用户分配工作项  and AssignedUser=''">
      <InParam name="@WorkItemId" type="Int64"/>
      <InParam name="@OperUser" nullable="true"/>
      <InParam name="@AssignUser"/>
      <InParam name="@LogDesc" nullable="true"/>
      <InParam name="@LogDate" type="DateTime" default_val="CURRENT_TIMESTAMP()"/>
      <Content_For_DB>
        <Sql exe_type="update" set_param="@UpRows=(0,0)">
          update biz_workitem set AssignedUser=[@AssignUser] where WorkItemId=[@WorkItemId] and State=0
        </Sql>
        <Sql exe_type="insert" if="@UpRows==1" desc="只有上一个语句更新成功,才能运行">
          insert into biz_workitem_log (WorkItemId,UserName,LogDate,LogType,LogDesc)
          values
          ([@WorkItemId],[@OperUser],[@LogDate],#WILogType.Assign,[@LogDesc])
        </Sql>
      </Content_For_DB>
    </Func>
    
    <Func name="AcquireWorkItemWithLog" desc="有权限的用户主动获得工作项">
      <InParam name="@WorkItemId" type="Int64"/>
      <InParam name="@OperUser"/>
      <InParam name="@LogDesc" nullable="true"/>
      <InParam name="@LogDate" type="DateTime" default_val="CURRENT_TIMESTAMP()"/>
      <Content_For_DB>
        <Sql exe_type="update" set_param="@UpRows=(0,0)">
          update biz_workitem set AssignedUser=[@OperUser] where WorkItemId=[@WorkItemId] and State=0 and AssignedUser=''
        </Sql>
        <Sql exe_type="insert" if="@UpRows==1" desc="只有上一个语句更新成功,才能运行">
          insert into biz_workitem_log (WorkItemId,UserName,LogDate,LogType,LogDesc)
          values
          ([@WorkItemId],[@OperUser],[@LogDate],#WILogType.Acquire,[@LogDesc])
        </Sql>
      </Content_For_DB>
    </Func>
    
    <Func name="DirectWorkItemWithLog" desc="有权限的用户把已经分配的工作项,分配给他人">
      <InParam name="@WorkItemId" type="Int64"/>
      <InParam name="@OperUser" nullable="true"/>
      <InParam name="@TargetUser"/>
      <InParam name="@LogDesc" nullable="true"/>
      <InParam name="@LogDate" type="DateTime" default_val="CURRENT_TIMESTAMP()"/>
      <Content_For_DB>
        <Sql exe_type="update" set_param="@UpRows=(0,0)">
          update biz_workitem set AssignedUser=[@TargetUser] where WorkItemId=[@WorkItemId] and State=0 and AssignedUser!='' and AssignedUser!=[@TargetUser]
        </Sql>
        <Sql exe_type="insert" if="@UpRows==1" desc="只有上一个语句更新成功,才能运行">
          insert into biz_workitem_log (WorkItemId,UserName,LogDate,LogType,LogDesc)
          values
          ([@WorkItemId],[@OperUser],[@LogDate],#WILogType.Direct,[@LogDesc])
        </Sql>
      </Content_For_DB>
    </Func>
    
    <Func name="DeleteWorkItemById" desc="" exe_type="nonquery">
      <InParam name="@WorkItemId" type="Int64"/>
      <Content_For_DB>
        <Sql exe_type="delete">
          delete from biz_workitem where WorkItemId=[@WorkItemId]
        </Sql>
      </Content_For_DB>
    </Func>
    
    <Func name="GetDataCont" desc="获得内部受保护的扩展信息">
      <InParam name="@WorkItemId" type="Int64"/>
      <Content_For_DB>
      	<Sql exe_type="select">
      	select DataCont from biz_workitem where WorkItemId=[@WorkItemId]
      	</Sql>
      </Content_For_DB>
    </Func>
    <Func name="SetDataCont">
      <InParam name="@WorkItemId" type="Int64"/>
      <InParam name="@DataCont" type="ByteArray" nullable="true"/>
      <Content_For_DB>
      	<Sql exe_type="update">
      	update biz_workitem set DataCont=[@DataCont] where WorkItemId=[@WorkItemId]
      	</Sql>
      </Content_For_DB>
    </Func>
  </Module>
  
  <Module name="WorkItemLog" desc="">
  	<Func name="GetLogByWorkItemId">
      <InParam name="@WorkItemId" type="Int64"/>
      <Content_For_DB>
      	<Sql exe_type="select">
      	select #WILogCols from biz_workItem_log where WorkItemId=[@WorkItemId]
      	</Sql>
      </Content_For_DB>
    </Func>
    <Func name="GetLogByWorkItemIdAndState">
      <InParam name="@WorkItemId" type="Int64"/>
      <InParam name="@LogType" type="Int32"/>
      <Content_For_DB>
      	<Sql exe_type="select">
      	select #WILogCols from biz_workItem_log where WorkItemId=[@WorkItemId] and LogType=[@LogType]
      	</Sql>
      </Content_For_DB>
    </Func>
  </Module>
  
  <ORMap class="com.dw.biz.workitem.BizWorkItem">
    <map column="WorkItemId" property="_WorkItemId" />
    <map column="Title" property="_Title" />
    <map column="ViewPath" property="_BizViewPath" />
    <map column="RelatedIdx" property="_RelatedIdx" />
    <map column="FinishActionPath" property="_FinishActionPath" />
    <map column="AssignedUser" property="_AssignedUser" />
    <map column="State" property="_State" />
    <map column="FlowInsId" property="_FlowInsId" />
    <map column="FlowNodeInsId" property="_FlowNodeInsId" />
    <map column="CostSecond" property="_CostSecond" />
    <map column="Priority" property="_Priority" />
    <map column="LimitDate" property="_LimitDate" />
    <map column="DataCont" property="_DataCont" />
  </ORMap>
  <ORMap class="com.dw.biz.workitem.BizWorkItemLog">
    <map column="LogId" property="_LogId" />
    <map column="WorkItemId" property="_WorkItemId" />
    <map column="UserName" property="_UserName" />
    <map column="LogDate" property="_LogDate" />
    <map column="LogType" property="_LogType" />
    <map column="LogDesc" property="_LogDesc" />
  </ORMap>
</Gdb>